<div class="user-management">
  <div class="page-header">
    <h2>Quản lý người dùng</h2>
    <button class="btn btn-primary" (click)="showCreateForm()">
      <i class="icon-plus"></i>
      Thêm người dùng
    </button>
  </div>

  <!-- Filters -->
  <div class="filters">
    <div class="filter-group">
      <input 
        type="text" 
        placeholder="Tìm kiếm theo tên, email..." 
        [(ngModel)]="searchTerm"
        (keyup.enter)="applyFilters()"
        class="form-control">
    </div>
    
    <div class="filter-group">
      <select [(ngModel)]="filterRole" (change)="applyFilters()" class="form-control">
        <option value="">Tất cả vai trò</option>
        <option *ngFor="let role of roles" [value]="role">{{role}}</option>
      </select>
    </div>
    
    <div class="filter-group">
      <select [(ngModel)]="filterStatus" (change)="applyFilters()" class="form-control">
        <option [ngValue]="undefined">Tất cả trạng thái</option>
        <option [ngValue]="true">Hoạt động</option>
        <option [ngValue]="false">Đã khóa</option>
      </select>
    </div>
    
    <button class="btn btn-secondary" (click)="applyFilters()">Lọc</button>
    <button class="btn btn-outline" (click)="clearFilters()">Xóa bộ lọc</button>
  </div>

  <!-- Users Table -->
  <div class="table-container" *ngIf="!loading">
    <table class="data-table">
      <thead>
        <tr>
          <th>Tên đăng nhập</th>
          <th>Họ tên</th>
          <th>Email</th>
          <th>Số điện thoại</th>
          <th>Vai trò</th>
          <th>Trạng thái</th>
          <th>Ngày tạo</th>
          <th>Thao tác</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of filteredUsers">
          <td>{{user.userName}}</td>
          <td>{{user.fullName}}</td>
          <td>{{user.email}}</td>
          <td>{{user.phoneNumber || '-'}}</td>
          <td>
            <span *ngFor="let role of user.roles; let last = last" class="role-badge">
              {{role}}<span *ngIf="!last">, </span>
            </span>
          </td>
          <td>
            <span class="status-badge" [class.active]="user.isActive" [class.inactive]="!user.isActive">
              {{user.isActive ? 'Hoạt động' : 'Đã khóa'}}
            </span>
          </td>
          <td>{{formatDate(user.createdAt)}}</td>
          <td>
            <div class="action-buttons">
              <button class="btn btn-sm btn-secondary" (click)="editUser(user)" title="Sửa">
                <i class="icon-edit"></i>
              </button>
              <button 
                class="btn btn-sm" 
                [class.btn-warning]="user.isActive" 
                [class.btn-success]="!user.isActive"
                (click)="toggleUserStatus(user)" 
                [title]="user.isActive ? 'Khóa tài khoản' : 'Mở khóa tài khoản'">
                <i [class.icon-lock]="user.isActive" [class.icon-unlock]="!user.isActive"></i>
              </button>
              <button class="btn btn-sm btn-danger" (click)="deleteUser(user)" title="Xóa">
                <i class="icon-delete"></i>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="filteredUsers.length === 0" class="no-data">
      Không tìm thấy người dùng nào
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading">
    <p>Đang tải dữ liệu...</p>
  </div>

  <!-- User Form Modal -->
  <div class="modal-overlay" *ngIf="showForm" (click)="showForm = false">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{editingUser ? 'Sửa người dùng' : 'Thêm người dùng mới'}}</h3>
        <button class="close-btn" (click)="showForm = false">&times;</button>
      </div>
      
      <form [formGroup]="userForm" (ngSubmit)="saveUser()" class="user-form">
        <div class="form-row">
          <div class="form-group">
            <label for="userName">Tên đăng nhập *</label>
            <input 
              type="text" 
              id="userName" 
              formControlName="userName" 
              class="form-control"
              [readonly]="editingUser !== null">
            <div *ngIf="userForm.get('userName')?.errors?.['required'] && userForm.get('userName')?.touched" 
                 class="error-message">
              Tên đăng nhập là bắt buộc
            </div>
          </div>
          
          <div class="form-group">
            <label for="email">Email *</label>
            <input 
              type="email" 
              id="email" 
              formControlName="email" 
              class="form-control"
              [readonly]="editingUser !== null">
            <div *ngIf="userForm.get('email')?.errors?.['required'] && userForm.get('email')?.touched" 
                 class="error-message">
              Email là bắt buộc
            </div>
            <div *ngIf="userForm.get('email')?.errors?.['email'] && userForm.get('email')?.touched" 
                 class="error-message">
              Email không hợp lệ
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="firstName">Họ *</label>
            <input type="text" id="firstName" formControlName="firstName" class="form-control">
            <div *ngIf="userForm.get('firstName')?.errors?.['required'] && userForm.get('firstName')?.touched" 
                 class="error-message">
              Họ là bắt buộc
            </div>
          </div>
          
          <div class="form-group">
            <label for="lastName">Tên *</label>
            <input type="text" id="lastName" formControlName="lastName" class="form-control">
            <div *ngIf="userForm.get('lastName')?.errors?.['required'] && userForm.get('lastName')?.touched" 
                 class="error-message">
              Tên là bắt buộc
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="phoneNumber">Số điện thoại</label>
          <input type="tel" id="phoneNumber" formControlName="phoneNumber" class="form-control">
        </div>

        <div *ngIf="!editingUser" class="form-row">
          <div class="form-group">
            <label for="password">Mật khẩu *</label>
            <input type="password" id="password" formControlName="password" class="form-control">
            <div *ngIf="userForm.get('password')?.errors?.['required'] && userForm.get('password')?.touched" 
                 class="error-message">
              Mật khẩu là bắt buộc
            </div>
            <div *ngIf="userForm.get('password')?.errors?.['minlength'] && userForm.get('password')?.touched" 
                 class="error-message">
              Mật khẩu phải có ít nhất 6 ký tự
            </div>
          </div>
          
          <div class="form-group">
            <label for="confirmPassword">Xác nhận mật khẩu *</label>
            <input type="password" id="confirmPassword" formControlName="confirmPassword" class="form-control">
            <div *ngIf="userForm.get('confirmPassword')?.errors?.['passwordMismatch'] && userForm.get('confirmPassword')?.touched" 
                 class="error-message">
              Mật khẩu xác nhận không khớp
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>Vai trò</label>
          <div class="checkbox-group">
            <label *ngFor="let role of roles" class="checkbox-label">
              <input 
                type="checkbox" 
                [checked]="isRoleSelected(role)"
                (change)="onRoleChange(role, $event.target ? $event.target.checked : false)">
              {{role}}
            </label>
          </div>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" formControlName="isActive">
            Kích hoạt tài khoản
          </label>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="showForm = false">Hủy</button>
          <button type="submit" class="btn btn-primary" [disabled]="userForm.invalid">
            {{editingUser ? 'Cập nhật' : 'Tạo mới'}}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
